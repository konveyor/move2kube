name: Release

on: create

jobs:
  build_and_test:
    if: startsWith(github.ref, 'refs/tags/v')
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - id: only_tag
        run: echo "::set-output name=tag::${GITHUB_REF#refs/tags/}"
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: ^1.15
      - run: make ci
      - run: make test-coverage
      - name: upload coverage
        uses: codecov/codecov-action@v1
      - if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#BD3232"
          SLACK_ICON: https://github.com/actions.png?size=48
          SLACK_MESSAGE: "Build and test failed for move2kube on tag ${{ steps.only_tag.outputs.tag }}"
          SLACK_TITLE: Failed
          SLACK_USERNAME: GitHubActions

  create_release_draft:
    needs: [build_and_test]
    name: Create release draft
    runs-on: ubuntu-latest
    steps:
      - id: only_tag
        run: echo "::set-output name=tag::${GITHUB_REF#refs/tags/}"
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v1
        with:
          node-version: "12"
      - name: create release draft
        run: |
          npm install github-release-notes@v0.17.3 -g
          gren release --draft --prerelease --tags ${{ steps.only_tag.outputs.tag }} --username=${{ github.repository_owner }} --repo=${{ github.event.repository.name }} --token=${{ secrets.GITHUB_TOKEN }}
      - run: make dist
      - name: upload release assets
        uses: HarikrishnanBalagopal/upload-release-action@v3
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: _dist/output/*
          file_glob: true
          overwrite: true
      - name: slack notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_ICON: https://github.com/actions.png?size=48
          SLACK_MESSAGE: "Release draft for move2kube ${{ steps.only_tag.outputs.tag }} created: https://github.com/konveyor/move2kube/releases"
          SLACK_TITLE: Success
          SLACK_USERNAME: GitHubActions

  image_build:
    needs: [build_and_test]
    name: Image build
    runs-on: ubuntu-latest
    steps:
      - id: only_tag
        run: echo "::set-output name=tag::${GITHUB_REF#refs/tags/}"
      - uses: actions/checkout@v2
      - name: pull latest image to reuse layers
        run: |
          docker pull quay.io/konveyor/move2kube:latest || true
          docker pull quay.io/konveyor/move2kube-builder:latest || true
      - run: echo "${{ secrets.QUAY_BOT_PASSWORD }}" | docker login --username "${{ secrets.QUAY_BOT_USERNAME }}" --password-stdin quay.io
      - name: build container image
        run: make cbuild
      - name: push image to quay
        run: |
          docker tag quay.io/konveyor/move2kube:latest quay.io/konveyor/move2kube:${{ steps.only_tag.outputs.tag }}
          docker push quay.io/konveyor/move2kube:${{ steps.only_tag.outputs.tag }}
      - name: run tests in move2kube-tests
        uses: felixp8/dispatch-and-wait@v0.1.0
        with:
          owner: konveyor
          repo: move2kube-tests
          token: ${{ secrets.MOVE2KUBE_PATOKEN }}
          event_type: cli_build
          client_payload: '{"tag": "${{ github.run_id }}"}'
          wait_time: 5
          max_time: 1200
      - name: success slack notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_ICON: https://github.com/actions.png?size=48
          SLACK_MESSAGE: "Built and pushed quay.io/konveyor/move2kube:${{ steps.only_tag.outputs.tag }}"
          SLACK_TITLE: Success
          SLACK_USERNAME: GitHubActions
      - if: failure()
        name: failure slack notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#BD3232"
          SLACK_ICON: https://github.com/actions.png?size=48
          SLACK_MESSAGE: "Failed to build and push image quay.io/konveyor/move2kube:${{ steps.only_tag.outputs.tag }}"
          SLACK_TITLE: Failed
          SLACK_USERNAME: GitHubActions

  trigger_other_repos:
    needs: [image_build]
    name: Trigger release in other repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          [
            "konveyor/move2kube-api",
            "konveyor/move2kube-ui",
            "konveyor/move2kube-operator",
            "konveyor/move2kube-tests",
          ]
    steps:
      - id: only_tag
        run: echo "::set-output name=tag::${GITHUB_REF#refs/tags/}"
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.MOVE2KUBE_PATOKEN }}
          repository: ${{ matrix.repo }}
          event-type: cli_tagged
          client-payload: '{"tag": "${{ steps.only_tag.outputs.tag }}"}'
